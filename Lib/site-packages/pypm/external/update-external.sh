#!/bin/bash
# Update src/pypm/external/* with the latest packges
# Also stirp unneeded files.

set -e

PROJECTS="
  zc.lockfile
  six
  http://github.com/ActiveState/applib/tarball/master#egg=applib
  http://github.com/ActiveState/appdirs/tarball/master#egg=appdirs"
PACKAGES="zc/lockfile six.py applib appdirs.py"
ENV=/tmp/deps-env

# Create virtualenv and install packages
rm -rf $ENV
virtualenv --no-site-packages $ENV
$ENV/bin/pip install --no-deps $PROJECTS
SPDIR=$ENV/lib/python?.?/site-packages/

# Copy package directories to the working directory
WRK=$ENV/work
mkdir $WRK
for pkg in $PACKAGES; do
    echo "copy: $SPDIR/$pkg -> $WRK"
    cp -r $SPDIR/$pkg $WRK/
done;

# Remove unneeded files from the working directory
pushd $WRK
py.cleanup

echo 'Removing unnecessary files ...'
mv lockfile/__init__.py zclockfile.py 
rm -rf lockfile


popd

# Now copy the working directory contents to src/pypm/external
TARGET=`dirname $0`/
echo 'Copying to source control ...', $WRK, '->', $TARGET
cp -r $WRK/* $TARGET/

# Also write a requirements file to know the package versions
echo 'Writing requirements file ...'
$ENV/bin/pip freeze > $TARGET/requirements.pip
cat $TARGET/requirements.pip


